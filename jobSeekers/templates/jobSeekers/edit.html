{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-3">Edit My Profile</h2>
  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}
    {{ template_data.form.non_field_errors }}
    <div class="row g-4">
      <!-- Left: Profile fields -->
      <div class="col-lg-7">
        <!-- Image preview (if image field exists) -->
        <div class="d-flex align-items-center gap-3 mb-3">
          {% if template_data.jobSeeker.image %}
            <img src="{{ template_data.jobSeeker.image.url }}" alt="Current image"
                 width="96" height="96"
                 style="width:96px;height:96px;border-radius:50%;object-fit:cover;object-position:center;display:block;">
          {% else %}
            <img src="{% static 'img/default_profile.jpg' %}" alt="Default image"
                 width="96" height="96"
                 style="width:96px;height:96px;border-radius:50%;object-fit:cover;object-position:center;display:block;">
          {% endif %}
          <div class="text-muted">Update your profile picture in the form below.</div>
        </div>

        <h5 class="mt-3">Profile Details</h5>
        <div class="mt-2">
          {% for field in template_data.form %}
            {% if field.name != 'hide_profile' and field.name != 'hide_image' and field.name != 'hide_headline' and field.name != 'hide_location' %}
            <div class="row align-items-center mb-3">
              <div class="col-sm-4 col-lg-3 text-muted">
                <label class="col-form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
              </div>
              <div class="col-sm-8 col-lg-9">
                {{ field }}
                {% if field.help_text %}
                  <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                  <div class="text-danger">{{ error }}</div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>

        <h5 class="mt-4">Privacy</h5>
        <div class="row align-items-center mb-3">
          <div class="col-sm-4 col-lg-3 text-muted">
            <label class="col-form-label" for="privacySelect">Visibility Options</label>
          </div>
          <div class="col-sm-8 col-lg-9">
            <select id="privacySelect" class="form-select" multiple>
              <option value="hide_profile">Hide entire profile</option>
              <option value="hide_image">Hide profile image</option>
              <option value="hide_headline">Hide headline</option>
              <option value="hide_location">Hide location</option>
            </select>
            <div class="form-text">Select all that apply.</div>
          </div>
        </div>

        <!-- Hidden actual form fields to submit privacy choices -->
        <div class="d-none">
          {{ template_data.form.hide_profile }}
          {{ template_data.form.hide_image }}
          {{ template_data.form.hide_headline }}
          {{ template_data.form.hide_location }}
        </div>

        <div class="mt-2">
          <button class="btn btn-dark" type="submit">Save Changes</button>
          <a href="{% url 'jobSeekers.my_profile' %}" class="btn btn-outline-secondary">Cancel</a>
        </div>
      </div>
  </form>

      <!-- Right: Experience / Skills / Links with inline add forms -->
      <div class="col-lg-5">
        <h5 class="mt-2">Experience</h5>
        <div class="mb-3">
          {% for experience in template_data.jobSeeker.experience.all %}
            <div class="border rounded p-2 mb-2">
              <div class="fw-semibold">{{ experience.name }} | {% if not template_data.jobSeeker.hide_location %} {{ experience.location }} {% endif %}</div>
              <div class="text-body-secondary small">
                {% if experience.endDate == "" %}
                  Since {{ experience.startDate }}
                {% else %}
                  {{ experience.startDate }} - {{ experience.endDate }}
                {% endif %}
              </div>
              <div class="small mt-1">{{ experience.description }}</div>
            </div>
          {% empty %}
            <p class="text-muted">No experiences listed.</p>
          {% endfor %}
        </div>

        <form method="post" action="{% url 'jobSeekers.add_experience' %}" class="border rounded p-3 mb-4">
          {% csrf_token %}
          <div class="fw-semibold mb-2">Add New Experience</div>
          <div class="row g-2">
            <div class="col-12"><input name="name" class="form-control" placeholder="Company Name" required></div>
            <div class="col-12"><input name="location" class="form-control" placeholder="Company Location" required></div>
            <div class="col-6"><input name="startDate" class="form-control" placeholder="Start Date" required></div>
            <div class="col-6"><input name="endDate" class="form-control" placeholder="End Date (blank if current)"></div>
            <div class="col-12"><textarea name="description" class="form-control" placeholder="Description" rows="3" required></textarea></div>
          </div>
          <button class="btn btn-primary mt-2" type="submit">Add Experience</button>
        </form>

        <h5 class="mt-4">Skills</h5>
        <div class="mb-2">
          {% for skill in template_data.jobSeeker.skills.all %}
            <span class="badge text-bg-light me-1 mb-1">{{ skill.name }}</span>
          {% empty %}
            <p class="text-muted">No skills listed.</p>
          {% endfor %}
        </div>
        <form method="post" action="{% url 'jobSeekers.add_skill' %}" class="d-flex gap-2 mb-4">
          {% csrf_token %}
          <input name="name" class="form-control" placeholder="Search or add skill" list="skillsList" required>
          <datalist id="skillsList">
            {% for s in template_data.all_skills %}
              <option value="{{ s }}"></option>
            {% endfor %}
          </datalist>
          <button class="btn btn-primary" type="submit">Add</button>
        </form>

        <h5>Links</h5>
        <div class="mb-2">
          {% for link in template_data.jobSeeker.links.all %}
            <div><a href="{{ link.url }}" target="_blank">{{ link.url }}</a></div>
          {% empty %}
            <p class="text-muted">No links listed.</p>
          {% endfor %}
        </div>
        <form method="post" action="{% url 'jobSeekers.add_link' %}" class="d-flex gap-2">
          {% csrf_token %}
          <input name="name" class="form-control" placeholder="https://example.com" required>
          <button class="btn btn-primary" type="submit">Add</button>
        </form>
      </div>
    </div>
  
</div>

<script>
  // Add Bootstrap classes to raw inputs
  (function() {
    const formEl = document.currentScript.closest('div.container').querySelector('form');
    formEl.querySelectorAll('input[type="text"], input[type="number"], input[type="file"], input[type="url"], textarea').forEach(el => el.classList.add('form-control'));
    formEl.querySelectorAll('select').forEach(el => el.classList.add('form-select'));
  })();

  // Sync privacy multi-select <-> hidden checkboxes
  (function() {
    const sel = document.getElementById('privacySelect');
    if (!sel) return;
    const fields = {
      hide_profile: document.querySelector('input[name$="hide_profile"]'),
      hide_image: document.querySelector('input[name$="hide_image"]'),
      hide_headline: document.querySelector('input[name$="hide_headline"]'),
      hide_location: document.querySelector('input[name$="hide_location"]'),
    };

    function fromFormToSelect() {
      Array.from(sel.options).forEach(opt => {
        const f = fields[opt.value];
        opt.selected = !!(f && f.checked);
      });
    }

    function fromSelectToForm() {
      const selected = new Set(Array.from(sel.selectedOptions).map(o => o.value));
      Object.entries(fields).forEach(([key, input]) => {
        if (input) input.checked = selected.has(key);
      });
    }

    sel.addEventListener('change', fromSelectToForm);
    fromFormToSelect();
  })();
</script>
{% endblock %}
