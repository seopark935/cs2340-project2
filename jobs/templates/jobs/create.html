{% extends "base.html" %}
{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    #map {
        height: 500px;  
        width: 100%;
    }
</style>

<div class="container py-4">
  <h2 class="mb-4">Post a New Job</h2>

  <form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Title -->
    <div class="mb-3">
      <label class="form-label">Job Title</label>
      {{ form.title }}
      {{ form.title.errors }}
    </div>

    <!-- Description -->
    <div class="mb-3">
      <label class="form-label">Description</label>
      {{ form.description }}
      {{ form.description.errors }}
    </div>

    <!-- Location -->
    <div class="mb-3">
      <label class="form-label">Location</label>
      {{ form.location }}
      {{ form.location.errors }}
    </div>

    <div class="mb-3">
      <label class="form-label">Address</label>
      {{ form.address }}
      {{ form.address.errors }}
    </div>

     <!-- Hidden fields for latitude and longitude -->
     <input type="hidden" id="lat" name="lat">
     <input type="hidden" id="lng" name="lng">
    
     <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Your map initialization script -->
    <script> 
document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('map').setView([37.7749, -122.4194], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker;
    const addressInput = document.getElementById('id_address');

    function updateHiddenFields(lat, lon) {
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lon;
    }

    // Map click â†’ reverse geocode
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        // Update or create marker
        if (marker) marker.setLatLng([lat, lon]);
        else marker = L.marker([lat, lon]).addTo(map);

        // Update hidden fields
        updateHiddenFields(lat, lon);

        // Reverse geocode via Django
        fetch(`/jobs/reverse_geocode/?lat=${lat}&lon=${lon}`)  // ensure trailing slash matches Django URL
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                return res.json();  // parse JSON safely
            })
            .then(data => {
                if (data && data.display_name) addressInput.value = data.display_name;
                else addressInput.value = 'Unknown location';
            })
            .catch(err => {
                console.error('Reverse geocode error:', err);
                addressInput.value = 'Unknown location';
            });
    });
});
</script>

    <!-- Remote type -->
    <div class="mb-3">
      <label class="form-label">Remote Type</label>
      {{ form.remote_type }}
      {{ form.remote_type.errors }}
    </div>

    <!-- Salary range -->
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Minimum Salary</label>
        {{ form.salary_min }}
        {{ form.salary_min.errors }}
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Maximum Salary</label>
        {{ form.salary_max }}
        {{ form.salary_max.errors }}
      </div>
    </div>

    <!-- Visa sponsorship -->
    <div class="mb-3 form-check">
      {{ form.visa_sponsorship }}
      <label class="form-check-label">Visa Sponsorship Available</label>
      {{ form.visa_sponsorship.errors }}
    </div>

    <!-- Skills -->
    <div class="mb-3">
      <label class="form-label">Required Skills</label>
      {{ form.skills }}
      {{ form.skills.errors }}
    </div>

    <button class="btn btn-dark" type="submit">Create Job</button>
    <a href="{% url 'jobs.list' %}" class="btn btn-outline-secondary">Cancel</a>
  </form>
</div>
{% endblock %}
