{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Post a New Job</h2>

  <form method="post" class="needs-validation" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Table-like layout: label (left) | input (right) -->
    <div class="mt-2">
      <!-- Title -->
      <div class="row align-items-center mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Job Title</label></div>
        <div class="col-sm-8 col-lg-9">{{ form.title }}{{ form.title.errors }}</div>
      </div>

      <!-- Description -->
      <div class="row align-items-start mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Description</label></div>
        <div class="col-sm-8 col-lg-9">{{ form.description }}{{ form.description.errors }}</div>
      </div>

      <!-- Location -->
      <div class="row align-items-center mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Location</label></div>
        <div class="col-sm-8 col-lg-9">{{ form.location }}{{ form.location.errors }}</div>
      </div>

      <!-- Remote Type -->
      <div class="row align-items-center mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Remote Type</label></div>
        <div class="col-sm-8 col-lg-9">{{ form.remote_type }}{{ form.remote_type.errors }}</div>
      </div>

      <!-- Min Experience -->
      <div class="row align-items-center mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Min Experience</label></div>
        <div class="col-sm-8 col-lg-9">{{ form.min_experience }}{{ form.min_experience.errors }}</div>
      </div>

      <!-- Salary Min -->
      <div class="row align-items-center mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Minimum Salary</label></div>
        <div class="col-sm-8 col-lg-9">{{ form.salary_min }}{{ form.salary_min.errors }}</div>
      </div>

      <!-- Salary Max -->
      <div class="row align-items-center mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Maximum Salary</label></div>
        <div class="col-sm-8 col-lg-9">{{ form.salary_max }}{{ form.salary_max.errors }}</div>
      </div>

      <!-- Visa sponsorship -->
      <div class="row align-items-center mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Visa Sponsorship</label></div>
        <div class="col-sm-8 col-lg-9">
          <div class="form-check">{{ form.visa_sponsorship }}<label class="form-check-label">Available</label></div>
          {{ form.visa_sponsorship.errors }}
        </div>
      </div>

      <!-- Skills (searchable picker) -->
      <div class="row align-items-start mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Required Skills</label></div>
        <div class="col-sm-8 col-lg-9">
          <input type="text" class="form-control mb-2" id="skillsSearch" placeholder="Search skills...">
          <div class="d-none" id="skillsSelectWrapper">{{ form.skills }}</div>
          {{ form.skills.errors }}
          <div id="skillsPicker" class="border rounded p-2" style="max-height: 260px; overflow:auto;"></div>
          <div id="skillsSelected" class="mt-2"></div>
        </div>
      </div>

      <!-- New skills (create on-the-fly) -->
      <div class="row align-items-center mb-3">
        <div class="col-sm-4 col-lg-3 text-muted"><label class="col-form-label">Add New Skills</label></div>
        <div class="col-sm-8 col-lg-9">{{ form.new_skills }}<div class="form-text">{{ form.new_skills.help_text }}</div>{{ form.new_skills.errors }}</div>
      </div>
    </div>

    <div class="mt-3">
      <button class="btn btn-dark" type="submit">Create Job</button>
      <a href="{% url 'jobs.list' %}" class="btn btn-outline-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
  // Ensure Bootstrap styles on default widgets
  (function() {
    const formEl = document.currentScript.closest('div.container').querySelector('form');
    formEl.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(el => el.classList.add('form-control'));
    formEl.querySelectorAll('select').forEach(el => el.classList.add('form-select'));
  })();

  // Build a searchable, accessible skills picker that syncs with the hidden select
  (function() {
    const wrapper = document.getElementById('skillsSelectWrapper');
    const select = wrapper ? wrapper.querySelector('select') : null;
    const list = document.getElementById('skillsPicker');
    const search = document.getElementById('skillsSearch');
    const chips = document.getElementById('skillsSelected');
    if (!select || !list) return;

    function render() {
      list.innerHTML = '';
      const term = (search.value || '').toLowerCase().trim();
      Array.from(select.options).forEach(opt => {
        const label = opt.text || '';
        if (term && !label.toLowerCase().includes(term)) return;
        const id = 'skill_' + opt.value;
        const item = document.createElement('div');
        item.className = 'form-check mb-1';
        item.innerHTML = `
          <input class="form-check-input" type="checkbox" id="${id}" value="${opt.value}" ${opt.selected ? 'checked' : ''}>
          <label class="form-check-label" for="${id}">${label}</label>
        `;
        item.querySelector('input').addEventListener('change', (e) => {
          opt.selected = e.target.checked;
          renderChips();
        });
        list.appendChild(item);
      });
    }

    function renderChips() {
      chips.innerHTML = '';
      Array.from(select.selectedOptions).forEach(opt => {
        const b = document.createElement('span');
        b.className = 'badge text-bg-light me-1 mb-1';
        b.style.cursor = 'pointer';
        b.textContent = opt.text;
        b.title = 'Click to remove';
        b.addEventListener('click', () => {
          opt.selected = false;
          const cb = document.getElementById('skill_' + opt.value);
          if (cb) cb.checked = false;
          renderChips();
        });
        chips.appendChild(b);
      });
    }

    search.addEventListener('input', render);
    render();
    renderChips();
  })();

  // No salary slider JS needed
</script>
{% endblock %}
