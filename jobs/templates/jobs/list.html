{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Jobs</h2>
    <a href="{% url 'map.index' %}" class="btn btn-outline-primary btn-sm">Open Map</a>
  </div>

  <form method="get" id="filterForm" class="d-flex flex-nowrap align-items-end gap-3 mb-4">
    <!-- Title -->
    <div class="flex-shrink-0" style="min-width:180px">
      <label class="form-label">Title</label>
      <input class="form-control" type="text" name="title" value="{{ request.GET.title|default_if_none:'' }}">
    </div>

    <!-- Location -->
    <div class="flex-shrink-0" style="min-width:180px">
      <label class="form-label">Location</label>
      <input class="form-control" type="text" id="id_location" name="location" value="{{ request.GET.location|default_if_none:'' }}">
    </div>

    

    <!-- Remote type -->
    <div class="flex-shrink-0" style="min-width:140px">
      <label class="form-label">Remote type</label>
      <select class="form-select" name="remote_type">
        {% for val,label in filter.form.remote_type.field.choices %}
          <option value="{{ val }}" {% if val in selected_remote_types %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    
    <!-- Visa sponsorship -->
    <div class="flex-shrink-0" style="min-width:140px">
      <label class="form-label">Visa sponsorship</label>
      <select class="form-select" name="visa_sponsorship">
        <option value="">Any</option>
        <option value="true"  {% if request.GET.visa_sponsorship == 'true' %}selected{% endif %}>Yes</option>
        <option value="false" {% if request.GET.visa_sponsorship == 'false' %}selected{% endif %}>No</option>
      </select>
    </div>

    <!-- Minimum salary slider (0 - 500k+, 50k steps) -->
    <div class="flex-shrink-0" style="min-width:180px">
      <label class="form-label">Minimum salary</label>
      <input type="hidden" name="salary_min" id="salaryMinHidden" value="{{ request.GET.salary_min|default_if_none:'' }}">
      <input id="salaryMinRangeSearch" type="range" class="form-range" min="0" max="500000" step="50000" style="width:150px">
      <div class="small text-muted" id="salaryRangeDisplaySearch" style="max-width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
    </div>

    <!-- Submit -->
    <div class="flex-shrink-0">
      <button class="btn btn-dark">Filter</button>
      <a href="{% url 'jobs.list' %}" class="btn btn-outline-secondary">Clear</a>
    </div>
  </form>

  <script>
    // Salary slider display sync
    (function() {
      const minH = document.getElementById('salaryMinHidden');
      const minR = document.getElementById('salaryMinRangeSearch');
      const disp = document.getElementById('salaryRangeDisplaySearch');
      if (!minH || !minR || !disp) return;
      const STEP = 50000, DEFAULT_MIN = 0, DEFAULT_MAX = 500000;
      function parseNum(v, fb) { const n = parseInt(v, 10); return isNaN(n) ? fb : n; }
      function label(n) { return n >= DEFAULT_MAX ? '$500k+' : `$${(n/1000).toFixed(0)}k+`; }
      let minVal = parseNum(minH.value, DEFAULT_MIN); minR.value = minVal;
      function update() { let a = parseNum(minR.value, DEFAULT_MIN); a = Math.round(a/STEP)*STEP; minR.value = a; minH.value = (a===DEFAULT_MIN)?'':a; disp.textContent = `Min salary: ${label(a)}`; }
      minR.addEventListener('input', update); update();
    })();
  </script>

  <h3 class="mb-3">Roles</h3>
  {% for job in jobs %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">{{ job.title }}</h5>

        <div class="text-muted mb-1">
          {{ job.location }} &bull; {{ job.get_remote_type_display }}
          {% if job.visa_sponsorship %} &bull; Visa Sponsorship{% endif %}
          {% if job.salary_min or job.salary_max %}
            &bull; $
            {% if job.salary_min %}{% widthratio job.salary_min 1000 1 %}k{% else %}?{% endif %}
            -
            {% if job.salary_max %}{% widthratio job.salary_max 1000 1 %}k{% else %}?{% endif %}
          {% endif %}
        </div>

        <div class="small text-secondary mb-2">
          Skills:
          {% for s in job.skills.all %}
            <span class="badge text-bg-light me-1">{{ s.name }}</span>
          {% empty %}
            <em>None</em>
          {% endfor %}
        </div>

        <p class="card-text">{{ job.description|truncatewords:40 }}</p>
        {% if user.is_authenticated %}
          {% if user.is_jobseeker %}
            {% if job.id in applied_jobs_status %}
              <a href="{% url 'application_status' job.id %}" class="btn btn-primary">Check Status</a>
            {% else %}
              <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#applyModal{{ job.id }}">Apply</button>
            {% endif %}
            <div class="modal fade" id="applyModal{{ job.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Apply for {{ job.title }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <form method="POST" action="{% url 'apply_job' job.id %}">
                      {% csrf_token %}
                      <div class="mb-3">
                        <label for="message" class="form-label">Message to Employer</label>
                        <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
                      </div>
                      <button type="submit" class="btn btn-primary">Send Application</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <p><em>Log in as Job Seeker to apply</em></p>
          {% endif %}
        {% else %}
          <p><em>Log in to apply for this job.</em></p>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p>No jobs match your filters.</p>
  {% endfor %}
</div>
{% endblock %}
