{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />


<div class="container py-4">
  <h2 class="mb-3">Jobs</h2>

  <!-- Filter form -->
  <form method="get" class="mb-4">
    <div class="d-flex flex-wrap align-items-end gap-3 pb-2">
      <!-- Title -->
      <div class="flex-shrink-0">
        <label class="form-label mb-1">Title</label>
        <input class="form-control" type="text" name="title" value="{{ request.GET.title|default_if_none:'' }}">
      </div>

      <!-- Location -->
      <div class="flex-shrink-0">
        <label class="form-label mb-1">Location</label>
        <input class="form-control" type="text" name="location" value="{{ request.GET.location|default_if_none:'' }}">
      </div>

      <!-- Remote type (dropdown like Visa sponsorship) -->
      <div class="flex-shrink-0">
        <label class="form-label mb-1">Remote type</label>
        <select class="form-select" name="remote_type">
          <option value="">Any</option>
          {% for val,label in filter.form.remote_type.field.choices %}
            <option value="{{ val }}" {% if val in selected_remote_types %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
  <form method="get" id="filterForm" class="row gy-2 gx-3 align-items-end mb-4">
    <!-- Title -->
    <div class="col-sm-3">
      <label class="form-label">Title</label>
      <input class="form-control" type="text" name="title" value="{{ request.GET.title|default_if_none:'' }}">
    </div>

    <!-- Location -->
    <div class="col-sm-3">
      <label class="form-label">Location</label>
      <input class="form-control" type="text" id="id_location" name="location" value="{{ request.GET.location|default_if_none:'' }}">
    </div>

     <!-- Hidden latitude & longitude fields -->
    <input type="hidden" id="lat" name="lat">
    <input type="hidden" id="lng" name="lng">

    <!-- Remote type -->
    <div class="col-sm-2">
      <label class="form-label">Remote type</label>
      <select class="form-select" name="remote_type" multiple>
        {% for val,label in filter.form.remote_type.field.choices %}
          <option value="{{ val }}" {% if val in selected_remote_types %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <small class="text-muted">Ctrl/Cmd-click for multi</small>
    </div>

      <!-- Visa sponsorship -->
      <div class="flex-shrink-0">
        <label class="form-label mb-1">Visa sponsorship</label>
        <select class="form-select" name="visa_sponsorship">
          <option value="">Any</option>
          <option value="true"  {% if request.GET.visa_sponsorship == 'true' %}selected{% endif %}>Yes</option>
          <option value="false" {% if request.GET.visa_sponsorship == 'false' %}selected{% endif %}>No</option>
        </select>
      </div>

      <!-- Minimum salary slider (0 - 500k+, 50k steps) -->
      <div class="flex-shrink-0">
        <label class="form-label mb-1">Minimum salary</label>

        <!-- Hidden field for filtering param -->
        <input type="hidden" name="salary_min" id="salaryMinHidden" value="{{ request.GET.salary_min|default_if_none:'' }}">

        <div class="d-flex align-items-center gap-2" style="min-width:240px;">
          <input id="salaryMinRangeSearch" type="range" class="form-range" min="0" max="500000" step="50000" style="flex:1">
        </div>
        <div class="small text-muted" id="salaryRangeDisplaySearch"></div>
      </div>

      <!-- Submit -->
      <div class="flex-shrink-0">
        <button class="btn btn-dark">Filter</button>
        <a href="{% url 'jobs.list' %}" class="btn btn-outline-secondary">Clear</a>
      </div>
    </div>
  </form>
  <!-- Leaflet JS -->
   <style>
    #map {
        height: 500px;  
        width: 100%;
    }
  </style>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

    var userIsAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

    function updateHiddenFields(lat, lon) {
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lon;
    }

    var filterForm = document.getElementById('filterForm');
    var locationInput = document.getElementById('id_location');

    if (!locationInput.value) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            map.setView([lat, lon], 14);
            updateHiddenFields(lat, lon); 
        }, function() {
            map.setView([37.7749, -122.4194], 10);
        });
      } else {
          map.setView([37.7749, -122.4194], 10); //default
      }
    } else {
      map.setView([37.7749, -122.4194], 10); //default
    }
    
    filterForm.addEventListener('submit', function(e) {
          e.preventDefault(); 
          var loc = locationInput.value;

          if (!loc) {
            filterForm.submit();
            return;
          }

          fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(loc))
            .then(response => response.json())
            .then(data => {
              if (data.length > 0) {
                var lat = parseFloat(data[0].lat);
                var lon = parseFloat(data[0].lon);

                // Update hidden fields
                updateHiddenFields(lat, lon);
                // Move map to that location for instant feedback
                map.setView([lat, lon], 13);

                // Now submit form after updating fields
                setTimeout(() => filterForm.submit(), 300);
              } else {
                alert('Location not found. Please try a more complete address.');
              }
            })
            .catch(err => {
              console.error('Geocoding error:', err);
              filterForm.submit(); 
            });
        });
    
    // Declare jobsData correctly
  var jobsData = {{ jobs_json|safe }};
  var appliedData = {{ applied_jobs |safe }};

  jobsData.forEach(function(job) {
      var isApplied = appliedData.includes(job.id);

      var popupContent = `
        <div>
          <b>${job.title}</b><br>
          <div class="text-muted mb-1">
            ${job.location} • ${job.remote_type}
            ${job.visa ? ' • Visa Sponsorship' : ''}
            ${job.salary_min || job.salary_max ? ` • $${job.salary_min || '?'}–${job.salary_max || '?'}` : ''}
          </div>
          <div class="small text-secondary mb-2">
            Skills: ${job.skills.length > 0 ? job.skills.map(s => `<span class="badge text-bg-light me-1">${s}</span>`).join('') : '<em>None</em>'}
          </div>
          <p class="card-text">${job.description.substring(0, 200)}${job.description.length > 200 ? '...' : ''}</p>
          ${userIsAuthenticated ? (isApplied
            ? `<button class="btn btn-secondary" disabled>Pending</button>`
            : `<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#applyModal${job.id}">Apply</button>`)
            : '<p><em>Log in to apply for this job.</em></p>'}
        </div>
      `;
      L.marker([job.lat, job.lng])
       .addTo(map)
       .bindPopup(popupContent);
  });

  </script>


  <script>
    // Single minimum salary slider for search (syncs to hidden GET field)
    (function() {
      const minH = document.getElementById('salaryMinHidden');
      const minR = document.getElementById('salaryMinRangeSearch');
      const disp = document.getElementById('salaryRangeDisplaySearch');
      if (!minH || !minR || !disp) return;

      const STEP = 50000;
      const DEFAULT_MIN = 0;
      const DEFAULT_MAX = 500000;

      function parseNum(v, fb) { const n = parseInt(v, 10); return isNaN(n) ? fb : n; }
      function label(n) { return n >= DEFAULT_MAX ? '$500k+' : `$${(n/1000).toFixed(0)}k+`; }

      let minVal = parseNum(minH.value, DEFAULT_MIN);
      minR.value = minVal;

      function update() {
        let a = parseNum(minR.value, DEFAULT_MIN);
        a = Math.round(a / STEP) * STEP;
        minR.value = a;
        minH.value = (a === DEFAULT_MIN) ? '' : a;
        disp.textContent = `Min salary: ${label(a)}`;
      }

      minR.addEventListener('input', update);
      update();
    })();
  </script>

  <h3 class="mb-3">Roles</h3>
  <!-- Job list -->
  {% for job in jobs %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">{{ job.title }}</h5>

        <div class="text-muted mb-1">
          {{ job.location }} • {{ job.get_remote_type_display }}
          {% if job.visa_sponsorship %} • Visa Sponsorship{% endif %}
          {% if job.salary_min or job.salary_max %}
            • $
            {% if job.salary_min %}{% widthratio job.salary_min 1000 1 %}k{% else %}?{% endif %}
            –
            {% if job.salary_max %}{% widthratio job.salary_max 1000 1 %}k{% else %}?{% endif %}
          {% endif %}
        </div>

        <div class="small text-secondary mb-2">
          Skills:
          {% for s in job.skills.all %}
            <span class="badge text-bg-light me-1">{{ s.name }}</span>
          {% empty %}
            <em>None</em>
          {% endfor %}
        </div>

        <p class="card-text">{{ job.description|truncatewords:40 }}</p>
           <!-- Apply button -->
        {% if user.is_authenticated %}
        {% if user.is_jobseeker %}
           {% if job.id in applied_jobs %}
           <a href="{% url 'application_status' job.id %}" class="btn btn-primary">
            Check Status
        </a>
          {% else %}
           <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#applyModal{{ job.id }}">
               Apply
           </button>
           {% endif %}
           <div class="modal fade" id="applyModal{{ job.id }}" tabindex="-1" aria-hidden="true">            <div class="modal-dialog">
              <div class="modal-content">
                
                <!-- Header -->
                <div class="modal-header">
                  <h5 class="modal-title">Apply for {{ job.title }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <!-- Body with form -->
                <div class="modal-body">
                  <form method="POST" action="{% url 'apply_job' job.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label for="message" class="form-label">Message to Employer</label>
                      <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Application</button>
                  </form>
                </div>
                
              </div>
            </div>
          </div>
          {% else %}
          <p><em>Log in as Job Seeker to apply</em></p>
          {% endif %}
         {% else %}
           <p><em>Log in to apply for this job.</em></p>
         {% endif %}
         
      </div>
       
    
    </div>
    
  {% empty %}
    <p>No jobs match your filters.</p>
  {% endfor %}
</div>
{% endblock %}
